<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ansar VDP - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-title { background: #198754; color: white; padding: 15px; text-align: center; margin-bottom: 20px; }

        /* PDF / Print Styling (A4 Size - Black & White) */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; margin: 0; padding: 0; font-family: 'Times New Roman', serif; }
            
            /* ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá ‡¶®‡¶æ */
            .no-print { display: none !important; } 
            
            /* ‡¶¨‡ßÅ‡¶ü‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü (‡¶Ø‡¶æ‡¶§‡ßá ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶™‡ßá‡¶ú ‡¶ú‡ßÅ‡ßú‡ßá ‡¶Ü‡¶∏‡ßá) */
            .container, .row, .col-12 { 
                max-width: 100% !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
            }

            #reportSection { display: block !important; width: 100%; }
            
            /* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® (‡¶∏‡¶æ‡¶¶‡¶æ ‡¶ï‡¶æ‡¶≤‡ßã ‡¶¨‡¶∞‡ßç‡¶°‡¶æ‡¶∞) */
            .table-responsive { overflow: visible !important; }
            table { width: 100% !important; border-collapse: collapse; font-size: 12pt; border: 1px solid black; }
            
            /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶°‡¶ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
            th, td { 
                border: 1px solid black !important; 
                padding: 8px 5px; 
                text-align: left; 
                color: black !important; /* ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶≤‡ßã */
            }

            /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
            thead, th { 
                background-color: transparent !important; 
                background: transparent !important;
                font-weight: bold;
                border-bottom: 2px solid black !important;
            }
            
            /* ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶π‡ßá‡¶°‡¶æ‡¶∞ */
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; border-bottom: 1px solid black; padding-bottom: 10px; }
            
            /* ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶è‡¶∞‡¶ø‡ßü‡¶æ ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
            .print-footer { display: none !important; }
        }
        
        /* ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
        .print-header { display: none; }
    </style>
</head>
<body>

<!-- Header -->
<div class="header-title no-print">
    <h3>Ansar VDP - Admin Control Panel</h3>
</div>

<div class="container mb-5">

    <!-- PART 1: MASTER DATA SETTINGS -->
    <div class="row no-print">
        <div class="col-12 mb-3">
            <h5 class="border-bottom pb-2">1. Master Data Settings (‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®)</h5>
        </div>

        <!-- Add Trade -->
        <div class="col-md-4 mb-3">
            <div class="card p-3">
                <label class="form-label fw-bold">Add New Trade</label>
                <div class="input-group">
                    <input type="text" id="newTradeInput" class="form-control" placeholder="Ex: Computer">
                    <button class="btn btn-primary" onclick="addToMaster('trades', 'newTradeInput')">Add</button>
                </div>
            </div>
        </div>

        <!-- Add District -->
        <div class="col-md-4 mb-3">
            <div class="card p-3">
                <label class="form-label fw-bold">Add New District</label>
                <div class="input-group">
                    <input type="text" id="newDistrictInput" class="form-control" placeholder="Ex: Dhaka">
                    <button class="btn btn-primary" onclick="addToMaster('districts', 'newDistrictInput')">Add</button>
                </div>
            </div>
        </div>

        <!-- Add Upazila -->
        <div class="col-md-4 mb-3">
            <div class="card p-3">
                <label class="form-label fw-bold">Add New Upazila</label>
                <div class="input-group">
                    <input type="text" id="newUpazilaInput" class="form-control" placeholder="Ex: Savar">
                    <button class="btn btn-primary" onclick="addToMaster('upazilas', 'newUpazilaInput')">Add</button>
                </div>
            </div>
        </div>
    </div>

    <hr class="no-print my-4">

    <!-- PART 2: REPORT GENERATION (PDF) -->
    <div class="row">
        <div class="col-12 no-print">
            <h5 class="border-bottom pb-2">2. PDF Report Generation (‡¶ü‡ßç‡¶∞‡ßá‡¶° ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü)</h5>
        </div>

        <!-- Filter Controls -->
        <div class="col-md-6 no-print mx-auto">
            <div class="card p-4 text-center bg-light">
                <label class="mb-2 fw-bold">Select Trade for PDF:</label>
                <div class="d-flex gap-2">
                    <select id="reportTradeSelect" class="form-select">
                        <option value="">-- ‡¶ü‡ßç‡¶∞‡ßá‡¶° ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                    </select>
                    <button class="btn btn-success" onclick="loadReportData()">Load Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report View Area (This part will be printed) -->
    <div id="reportSection" class="mt-4" style="display:none;">
        
        <!-- Print Header -->
        <div class="print-header">
            <h2>Ansar VDP Training Center</h2>
            <h4>Student Bio Data List</h4>
            <p><strong>Selected Trade:</strong> <span id="displayTradeName"></span> | <strong>Date:</strong> <span id="printDate"></span></p>
        </div>

        <!-- Data Table -->
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="width: 5%;">SL</th>
                        <th style="width: 25%;">Student Name</th>
                        <th style="width: 25%;">Father's Name</th>
                        <th style="width: 15%;">Mobile</th>
                        <th style="width: 15%;">District</th>
                        <th style="width: 15%;">Upazila</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Footer removed as per request -->
    </div>

    <!-- Print Button Floating -->
    <div class="text-center mt-3 no-print" id="printBtnContainer" style="display:none;">
        <button onclick="window.print()" class="btn btn-warning btn-lg fw-bold">üñ®Ô∏è Print / Save as PDF (A4)</button>
    </div>

</div>

<!-- Firebase Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBEfs_yi_U5AObahTTLQGK5Sj4k1wSBXb0",
    authDomain: "ansar-vdp.firebaseapp.com",
    projectId: "ansar-vdp",
    storageBucket: "ansar-vdp.firebasestorage.app",
    messagingSenderId: "934221161236",
    appId: "1:934221161236:web:bd4797c63c4fd5418f9801"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- 1. Master Data Adding Function ---
  window.addToMaster = async (collectionName, inputId) => {
      const inputEl = document.getElementById(inputId);
      const value = inputEl.value.trim();

      if (!value) {
          alert("Please write a name first!");
          return;
      }

      try {
          await addDoc(collection(db, collectionName), { name: value });
          alert(`Success! "${value}" added to ${collectionName}.`);
          inputEl.value = "";
      } catch (e) {
          console.error(e);
          alert("Error adding data.");
      }
  };

  // --- 2. Load Trades into Dropdown (For Report) ---
  const tradeSelect = document.getElementById("reportTradeSelect");
  onSnapshot(query(collection(db, "trades"), orderBy("name")), (snapshot) => {
      tradeSelect.innerHTML = `<option value="">-- ‡¶ü‡ßç‡¶∞‡ßá‡¶° ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® --</option>`;
      snapshot.forEach(doc => {
          tradeSelect.innerHTML += `<option value="${doc.data().name}">${doc.data().name}</option>`;
      });
  });

  // --- 3. Load Report Data based on Specific Trade ---
  window.loadReportData = async () => {
      const selectedTrade = tradeSelect.value;
      
      if (!selectedTrade) {
          alert("Please select a trade first!");
          return;
      }

      const tbody = document.getElementById("reportTableBody");
      tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;

      // Query: Get students where trade == selectedTrade
      const q = query(collection(db, "students_biodata"), where("trade", "==", selectedTrade));

      try {
          const snapshot = await getDocs(q);
          
          if (snapshot.empty) {
              tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‡¶è‡¶á ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</td></tr>`;
              document.getElementById("printBtnContainer").style.display = "none";
              return;
          }

          tbody.innerHTML = "";
          let serial = 1;
          
          snapshot.forEach(doc => {
              const data = doc.data();
              const row = `
                <tr>
                    <td>${serial++}</td>
                    <td>${data.studentName}</td>
                    <td>${data.fatherName}</td>
                    <td>${data.mobileNumber}</td>
                    <td>${data.district}</td>
                    <td>${data.upazila}</td>
                </tr>
              `;
              tbody.innerHTML += row;
          });

          // Show Report Section & Print Button
          document.getElementById("reportSection").style.display = "block";
          document.getElementById("displayTradeName").innerText = selectedTrade;
          document.getElementById("printDate").innerText = new Date().toLocaleDateString("bn-BD");
          document.getElementById("printBtnContainer").style.display = "block";

      } catch (e) {
          console.error(e);
          alert("Error fetching report data: " + e.message);
      }
  };

</script>

</body>
</html>